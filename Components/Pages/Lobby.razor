@page "/lobby"
@inject IPlayerSessionService PlayerSession
@inject IGameManager GameManager
@inject NavigationManager Navigation

<PageTitle>Lobby - MiniRisk</PageTitle>

<div class="premium-container">
    <div class="glass-card animate-fade-in" style="max-width: 800px;">
        <div class="lobby-header">
            <h1 class="game-title">Lobby</h1>
            <div class="player-info">
                <span>Jugando como: <strong>@PlayerSession.PlayerName</strong></span>
                <button class="btn-logout" @onclick="Logout">Cerrar Sesión</button>
            </div>
        </div>

        <div class="lobby-content">
            <div class="create-game-section">
                <h3>Crear Nueva Partida</h3>
                <div class="input-group">
                    <input type="text" @bind="newGameName" class="premium-input" placeholder="Nombre de la partida..." />
                    <button class="premium-btn" @onclick="CreateGame" disabled="@(string.IsNullOrWhiteSpace(newGameName))">
                        ➕ Crear
                    </button>
                </div>
            </div>

            <div class="games-list-section">
                <h3>Partidas Disponibles</h3>
                @if (availableGames.Count == 0)
                {
                    <p class="empty-message">No hay partidas disponibles en este momento. ¡Crea una!</p>
                }
                else
                {
                    <div class="games-grid">
                        @foreach (var game in availableGames)
                        {
                            <div class="game-card">
                                <div class="game-info">
                                    <span class="game-name">@game.Name</span>
                                    <span class="game-creator">Por: @game.CreatorName</span>
                                    <span class="game-players">@game.CurrentPlayers / @game.MaxPlayers jugadores</span>
                                </div>
                                <button class="premium-btn btn-sm" @onclick="() => JoinGame(game.Id)">
                                    Unirse
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 1rem;
    }

    .player-info {
        font-size: 0.9rem;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }

    .btn-logout {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        padding: 0;
        font-size: 0.8rem;
        text-decoration: underline;
    }

    .lobby-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        text-align: left;
    }

    h3 {
        color: var(--accent);
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
    }

    .empty-message {
        opacity: 0.6;
        font-style: italic;
    }

    .games-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .game-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s ease;
    }

    .game-card:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .game-info {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .game-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .game-creator, .game-players {
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .lobby-content {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private string newGameName = "";
    private List<GameSummary> availableGames = [];

    protected override void OnInitialized()
    {
        if (!PlayerSession.IsIdentified)
        {
            Navigation.NavigateTo("/");
            return;
        }

        RefreshGames();
    }

    private void RefreshGames()
    {
        availableGames = GameManager.GetAvailableGames();
    }

    private void CreateGame()
    {
        if (string.IsNullOrWhiteSpace(newGameName)) return;

        var settings = new GameSettings { MaxPlayers = 6 }; // Default
        var summary = GameManager.CreateGame(newGameName, PlayerSession.PlayerId, PlayerSession.PlayerName, settings);
        
        JoinGame(summary.Id);
    }

    private void JoinGame(string gameId)
    {
        PlayerSession.JoinGame(gameId);
        Navigation.NavigateTo($"/game/{gameId}");
    }

    private void Logout()
    {
        GameManager.UnregisterConnection(PlayerSession.PlayerId); // Not perfectly accurate but works for clearing memory
        PlayerSession.Clear();
        Navigation.NavigateTo("/");
    }
}
