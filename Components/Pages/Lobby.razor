@page "/lobby"
@using Microsoft.AspNetCore.SignalR.Client
@using MiniRisk.Models
@using MiniRisk.Models.Dtos
@inject IPlayerSessionService PlayerSession
@inject IGameManager GameManager
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>MiniRisk â€” Lobby</PageTitle>

<div class="lobby-container">
    <header class="lobby-header">
        <h1 class="logo-text">ðŸŽ² MiniRisk</h1>
        <div class="player-badge">
            @PlayerSession.PlayerName
            <span class="connection-dot connected"></span>
        </div>
    </header>

    @if (_currentGameId != null)
    {
        <!-- Sala de espera -->
        <MiniRisk.Components.Shared.WaitingRoom GameId="@_currentGameId"
                     PlayerId="@PlayerSession.PlayerId"
                     IsCreator="@_isCreator"
                     OnLeave="HandleLeaveGame"
                     OnStart="HandleStartGame"
                     HubConnection="_hubConnection" />
    }
    else
    {
        <!-- Lista de partidas -->
        <div class="lobby-content">
            <div class="lobby-title-row">
                <h2>Partidas Disponibles</h2>
                <button class="btn btn-primary" @onclick="() => _showCreateDialog = true">
                    + Crear Partida
                </button>
            </div>

            @if (_games.Count == 0)
            {
                <div class="empty-state">
                    <p>No hay partidas disponibles.</p>
                    <p>Â¡Crea una nueva para empezar!</p>
                </div>
            }
            else
            {
                <div class="game-list">
                    @foreach (var game in _games)
                    {
                        <MiniRisk.Components.Shared.GameCard Game="@game" OnJoin="() => HandleJoinGame(game.Id)" />
                    }
                </div>
            }
        </div>
    }

    @if (_showCreateDialog)
    {
        <MiniRisk.Components.Shared.CreateGameDialog OnCreate="HandleCreateGame"
                          OnCancel="() => _showCreateDialog = false" />
    }
</div>

@code {
    private HubConnection? _hubConnection;
    private List<GameSummary> _games = [];
    private string? _currentGameId;
    private bool _isCreator;
    private bool _showCreateDialog;

    protected override async Task OnInitializedAsync()
    {
        if (!PlayerSession.IsIdentified)
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Conectar al hub
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        // Escuchar actualizaciones del lobby
        _hubConnection.On<List<GameSummary>>("LobbyUpdated", games =>
        {
            _games = games;
            InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<string>("GameStarting", gameId =>
        {
            Navigation.NavigateTo($"/game/{gameId}");
        });

        await _hubConnection.StartAsync();

        // Registrar conexiÃ³n y obtener partidas
        await _hubConnection.SendAsync("RegisterPlayer",
            PlayerSession.PlayerId, PlayerSession.PlayerName);

        _games = GameManager.GetAvailableGames();
    }

    private async Task HandleCreateGame((string name, GameSettings settings) data)
    {
        _showCreateDialog = false;

        var summary = GameManager.CreateGame(
            data.name, PlayerSession.PlayerId, PlayerSession.PlayerName, data.settings);

        await HandleJoinGame(summary.Id);
        _isCreator = true;
    }

    private async Task HandleJoinGame(string gameId)
    {
        if (_hubConnection == null) return;

        var result = GameManager.AddPlayer(
            gameId, PlayerSession.PlayerId,
            PlayerSession.PlayerName, _hubConnection.ConnectionId!);

        if (result.Success)
        {
            _currentGameId = gameId;
            PlayerSession.JoinGame(gameId);
            PlayerSession.SetColor(result.AssignedColor);

            await _hubConnection.SendAsync("JoinGameGroup", gameId);
        }
    }

    private async Task HandleLeaveGame()
    {
        if (_currentGameId != null && _hubConnection != null)
        {
            GameManager.RemovePlayer(_currentGameId, PlayerSession.PlayerId);
            await _hubConnection.SendAsync("LeaveGameGroup", _currentGameId);

            _currentGameId = null;
            _isCreator = false;
            PlayerSession.LeaveGame();
            _games = GameManager.GetAvailableGames();
        }
    }

    private async Task HandleStartGame()
    {
        if (_currentGameId != null && _hubConnection != null)
        {
            await _hubConnection.SendAsync("StartGame", _currentGameId, PlayerSession.PlayerId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
