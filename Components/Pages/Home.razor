@page "/"
@inject IPlayerSessionService PlayerSession
@inject IGameManager GameManager
@inject NavigationManager Navigation

<PageTitle>MiniRisk — Ingresa tu nombre</PageTitle>

<div class="home-container">
    <div class="home-logo">
        <h1 class="logo-text">🎲 MiniRisk</h1>
        <p class="logo-subtitle">Conquista el mundo con tus amigos</p>
    </div>

    @if (_reconnectionInfo != null)
    {
        <div class="reconnection-banner">
            <p>Estabas en la partida <strong>@_reconnectionInfo.GameName</strong>.</p>
            <div class="banner-actions">
                <button class="btn btn-primary" @onclick="HandleReconnect">Reconectar</button>
                <button class="btn btn-secondary" @onclick="HandleDeclineReconnect">Ignorar</button>
            </div>
        </div>
    }

    <div class="home-card animate-fade-in">
        <label class="input-label" for="playerName">Tu nombre</label>
        <input id="playerName"
               class="input @(_errorMessage != null ? "input--error" : "")"
               type="text"
               maxlength="20"
               placeholder="Ej: Carlos"
               @bind="_playerName"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown" />

        @if (_errorMessage != null)
        {
            <p class="input-error">@_errorMessage</p>
        }

        <button id="btnEnter"
                class="btn btn-primary btn-full"
                style="margin-top: 1.5rem;"
                disabled="@(!CanEnter)"
                @onclick="HandleEnter">
            ENTRAR →
        </button>
    </div>

    <p class="home-footer" style="margin-top: 2rem; color: var(--text-secondary); font-size: var(--text-sm);">v1.0 • Red Local</p>
</div>

@code {
    private string _playerName = string.Empty;
    private string? _errorMessage;
    private MiniRisk.Models.ReconnectionInfo? _reconnectionInfo;

    private bool CanEnter => !string.IsNullOrWhiteSpace(_playerName)
                          && _playerName.Trim().Length >= 3
                          && _errorMessage == null;

    protected override void OnInitialized()
    {
        // Si ya se identificó, redirigir al lobby
        if (PlayerSession.IsIdentified)
        {
            Navigation.NavigateTo("/lobby");
        }
    }

    private void HandleEnter()
    {
        var name = _playerName.Trim();

        // Validaciones
        if (name.Length < 3 || name.Length > 20)
        {
            _errorMessage = "El nombre debe tener entre 3 y 20 caracteres.";
            return;
        }

        if (!System.Text.RegularExpressions.Regex.IsMatch(name, @"^[a-zA-Z0-9áéíóúñÁÉÍÓÚÑ\s]+$"))
        {
            _errorMessage = "Solo se permiten letras, números y espacios.";
            return;
        }

        if (GameManager.IsNameTaken(name))
        {
            _errorMessage = "Ese nombre ya está en uso.";
            return;
        }

        // Comprobar reconexión
        _reconnectionInfo = GameManager.GetReconnectionInfo(name);
        if (_reconnectionInfo != null)
        {
            return; // Mostrar el banner de reconexión
        }

        // Identificar y navegar
        PlayerSession.SetPlayer(name);
        Navigation.NavigateTo("/lobby");
    }

    private void HandleReconnect()
    {
        PlayerSession.SetPlayer(_playerName.Trim());
        PlayerSession.JoinGame(_reconnectionInfo!.GameId);
        Navigation.NavigateTo($"/game/{_reconnectionInfo.GameId}");
    }

    private void HandleDeclineReconnect()
    {
        _reconnectionInfo = null;
        PlayerSession.SetPlayer(_playerName.Trim());
        Navigation.NavigateTo("/lobby");
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        _errorMessage = null; // Limpiar error al escribir
        if (e.Key == "Enter" && CanEnter)
        {
            HandleEnter();
        }
    }
}
